# ICMP 
ICMP(Internet Control Message Protocol)是一种面向无连接的协议，用于传输出错报告控制信息。它是一个非常重要的协议，它对于网络安全具有极其重要的意义。

ICMP是在RFC 792中定义的互联网协议族之一。通常用于返回的错误信息或是分析路由。ICMP错误消息总是包括了源数据并返回给发送者。 ICMP错误消息的例子之一是TTL值过期。每个路由器在转发数据报的时候都会把IP包头中的TTL值减1。如果TTL值为0，“TTL在传输中过期”的消息将会回报给源地址。 每个ICMP消息都是直接封装在一个IP数据包中的，因此，和UDP一样，ICMP是不可靠的。ICMP报文在IP帧结构的首部协议类型字段（Protocol 8bit)的值=1.

## 报文格式
<table>
   <tr>
      <td colspan="2">IP数据报</td>
   </tr>
   <tr>
      <td>首部</td>
      <td>数据部分</td>
   </tr>
   <tr>
      <td> </td>
      <td>ICMP报文/IGMP报文</td>
   </tr>
</table>


ICMP报头从IP报头的第160位开始（IP首部20字节）（除非使用了IP报头的可选部分）。

<table>
   <tr>
      <td>Bits</td>
      <td>160-167</td>
      <td>168-175</td>
      <td>176-183</td>
      <td>184-191</td>
   </tr>
   <tr>
      <td>160</td>
      <td>Type</td>
      <td>Code</td>
      <td colspan="2">校验码（checksum）</td>
   </tr>
   <tr>
      <td>192</td>
      <td colspan="2">ID</td>
      <td colspan="2">序号（sequence）</td>
   </tr>
    <tr>
      <td></td>
      <td colspan="4">数据部分(长度取决于类型)</td>

   </tr>
</table>

- Type - ICMP的类型,标识生成的错误报文；
- Code - 进一步划分ICMP的类型,该字段用来查找产生错误的原因.；例如，ICMP的目标不可达类型可以把这个位设为1至15等来表示不同的意思。
- Checksum - 校验码部分,这个字段包含有从ICMP报头和数据部分计算得来的，用于检查错误的数据，其中此校验码字段的值视为0。
- ID - 这个字段包含了ID值，在Echo Reply类型的消息中要返回这个字段。
- Sequence - 这个字段包含一个序号，同样要在Echo Reply类型的消息中要返回这个字段。

虽然ICMP是包含在IP数据包中的，但是对ICMP消息通常会特殊处理，会和一般IP数据包的处理不同，而不是作为IP的一个子协议来处理。在很多时候，需要去查看ICMP消息的内容，然后发送适当的错误消息到那个原来产生IP数据包的程序，即那个导致ICMP消息被发送的IP数据包。

ICMP提供一致易懂的出错报告信息。发送的出错报文返回到发送原数据的设备，因为只有发送设备才是出错报文的逻辑接受者。发送设备随后可根据ICMP报文确定发生错误的类型，并确定如何才能更好地重发失败的数据包。但是ICMP唯一的功能是报告问题而不是纠正错误，纠正错误的任务由发送方完成。

ICMP 依靠IP来完成它的任务，它是IP的主要部分。它与传输协议（如TCP和UDP）显著不同：它一般不用于在两点间传输数据。它通常不由网络程序直接使用，除了ping和traceroute这两个特别的例子。 IPv4中的ICMP被称作ICMPv4，IPv6中的ICMP则被称作ICMPv6。

# IGMP
主机IP软件需要进行组播扩展，才能使主机能够在本地完了过上收发组播分组。但仅靠这一点是不够的，因为跨越多个网络的组播转发必须依赖于路由器。

路由器为建立组播转发路由必需了解每个组员在Internet中的分布，这要求主机必须能将其所在的组播组通知给本地路由器，这也是建立组播转发路由的基础。主机与本地路由器之间使用Internet组管理协议(Internet Group Management Protocol)来进行组播组成员信息的交互。

在此基础上，本地路由器再你信息与她组播路由器通信，传播组播组的成员信息，并建立组播路由。这个过程与路由器之间的常规单播路由。这个过程与路由器之间的常规单播路由的传播十分相似。IGMP是TCP/IP中重要标准之一，所有IP组播系统（包括主机和路由器）都需要支持IGMP协议。

组播协议包括组成员管理协议和组播路由协议。组成员管理协议用于管理组播组成员的加入和离开，组播路由协议负责在路由器之间交互信息来建立组播树。IGMP属于前者，是组播路由器用来维护组播组成员信息的协议，运行于主机和和组播路由器之间。IGMP 信息封装在IP报文中，其IP的协议号为2。

若一个主机想要接收发送到一个特定组的组播数据包，它需要监听发往那个特定组的所有数据包。为解决Internet上组播数据包的路径选择，主机需通过通知其子网上的组播路由器来加入或离开一个组，组播中采用IGMP来完成这一任务。这样，组播路由器就可以知道网络上组播组的成员，并由此决定是否向它们的网络转发组播数据包。当一个组播路由器收到一个组播分组时，它检查数据包的组播目的地址，仅当接口上有那个组的成员时才向其转发。

IGMP提供了在转发组播数据包到目的地的最后阶段所需的信息，实现如下双向的功能：
1. 主机通过IGMP通知路由器希望接收或离开某个特定组播组的信息。
2. 路由器通过IGMP周期性地查询局域网内的组播组成员是否处于活动状态，实现所连网段组成员关系的收集与维护。

**【问题】为什么IGMP的运输层协议是UDP?**   
因为只有UDP才有广播、组播的传递方式；而TCP是一对一连接通信。多播的重点是高效的把同一个包尽可能多的发送到不同的，甚至可能是未知的设备。但是TCP连接是一对一明确的，只能单播。

## 报文格式
IGMP共有三个版本，即IGMP v1、v2 和 v3。

像ICMP（因特网控制报文协议）一样, IGMP是一个IP的组成部分。它要求通过所有主机对应的2级IP多点广播规范完全地实现。IGMP报文被压缩在IP数据报中,具有一个IP协议号码2.所有IGMP报文具有以下格式：
```
   0                   1                   2                   3    
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1  
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
  |     Type      |     Code      |           Checksum            | 
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
  |                          Identifier                           | 
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
  |                         Group Address                         | 
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
  |                                                               | 
  +                         Access Key                            + 
  |                                                               | 
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
```
